library(tidyverse)
library(dbplyr)
library(sf)
library(lubridate)
library(RcppRoll)
library(DT)
library(readxl)
library(RPostgreSQL)
library(rsdmx)
library(stringi)
library(plyr)
library(ggplot2)
library(kableExtra)
library(plotly)


# Données complémentaires ----

bdroe <- 
  sf::read_sf(dsn = "data/outputs/BDROE_interne_BZH_PDL_20241201.gpkg") %>%
  st_transform(crs = 2154)

dprt <- 
  sf::read_sf(dsn = "data/DEPARTEMENT.shp") %>%
  st_transform(crs = 2154) %>%
  filter(INSEE_DEP %in% c('22', '29', '35', '44', '49', '53', '56', '72', '85'))

## Mise à jour des noms de département ----

bdroe_nom <- bdroe  %>%
  left_join(dprt %>%
              st_drop_geometry(), 
            by = c("dept_code" = "INSEE_DEP")) %>%  
  mutate(dept_nom = nom_dept) %>%
  distinct() 

bdroe <- bdroe_nom %>%
  select(-nom_dept)

# Exploitation des résultats ----

# Création d'une couche de synthèse des manque de complétude par bassin versant de masse d'eau ----

analyse_manque_me <- bdroe_dr2 %>%
  st_join(masse_eau) %>% 
  sf::st_drop_geometry() %>% 
  filter(statut_nom != 'Gelé' & derasement_solde != '1' & !is.na(cdbvspemdo)) %>%
  select(identifiant_roe, cdbvspemdo, manque_op, manque_l2, manque_etat, manque_type, manque_hc, manque_fip, non_valides) %>%
  group_by (cdbvspemdo) %>%
  dplyr::summarise(
    ntot_manque_op = sum(manque_op, na.rm = T),
    ntot_manque_l2 = sum(manque_l2, na.rm = T),
    ntot_manque_etat = sum(manque_etat, na.rm = T),
    ntot_manque_type = sum(manque_type, na.rm = T),
    ntot_manque_hc = sum(manque_hc, na.rm = T),
    ntot_manque_fip = sum(manque_fip, na.rm = T),
    ntot_non_valide = sum(non_valides, na.rm = T),)

me_manques_bdroe <- masse_eau %>%
  dplyr::left_join(analyse_manque_me ,
                   by = c("cdbvspemdo" = "cdbvspemdo")) %>%
  select(cdbvspemdo, 
         ntot_manque_op, 
         ntot_manque_l2, 
         ntot_manque_etat, 
         ntot_manque_type, 
         ntot_manque_hc, 
         ntot_manque_fip, 
         ntot_non_valide)

# Création d'une table de synthèse par département/region/interrégion ----

dept_analyse_manques <- bdroe %>%
  sf::st_drop_geometry() %>% 
  filter(statut_nom != 'Gelé' & derasement_solde != '1') %>%
  select(dept_nom, manque_op, manque_l2, manque_etat, manque_type, manque_hc, manque_fip, non_valides, manque_atg_l2, mec_atg_hc) %>%
  as.data.frame() %>%
  group_by(dept_nom) %>%
  dplyr::summarise(ntot_ouvrage_analyses = n(),
            ntot_manque_op = sum(manque_op, na.rm = T),
            ntot_manque_l2 = sum(manque_l2, na.rm = T), 
            ntot_manque_etat = sum(manque_etat, na.rm = T), 
            ntot_manque_type = sum(manque_type, na.rm = T), 
            ntot_manque_hc = sum(manque_hc, na.rm = T), 
            ntot_manque_fip = sum(manque_fip, na.rm = T),
            ntot_non_valide = sum(non_valides, na.rm = T), 
            ntot_manque_atg_l2 = sum(manque_atg_l2, na.rm = T),
            ntot_mec_atg_hc = sum(mec_atg_hc, na.rm = T))

synth_interreg <- 
  bdroe %>%
  sf::st_drop_geometry() %>% 
  filter(statut_nom != 'Gelé' & derasement_solde != '1') %>%
  select(dept_nom, manque_op, manque_l2, manque_etat, manque_type, manque_hc, manque_fip, non_valides, manque_atg_l2, mec_atg_hc) %>%
  as.data.frame() %>%
  group_by(dept_nom) %>%
  sf::st_drop_geometry() %>% 
  dplyr::summarise(ntot_ouvrage_analyses = n(),
            ntot_non_valide = sum(non_valides, na.rm = T), 
            ntot_manque_op = sum(manque_op, na.rm = T),
            ntot_manque_l2 = sum(manque_l2, na.rm = T), 
            ntot_manque_etat = sum(manque_etat, na.rm = T), 
            ntot_manque_type = sum(manque_type, na.rm = T), 
            ntot_manque_hc = sum(manque_hc, na.rm = T), 
            ntot_manque_fpi = sum(manque_fip, na.rm = T),
            ntot_manque_atg_l2 = sum(manque_atg_l2, na.rm = T),
            ntot_mec_atg_hc = sum(mec_atg_hc, na.rm = T)) %>%
  mutate(`(% oa)` = round(ntot_ouvrage_analyses*100/sum(ntot_ouvrage_analyses), 1),
         `(% nv)` = round(ntot_non_valide*100/sum(ntot_non_valide), 1),
         `(% op)` = round(ntot_manque_op*100/sum(ntot_manque_op), 1),
         `(% l2)` = round(ntot_manque_l2*100/sum(ntot_manque_l2), 1),
         `(% etat)` = round(ntot_manque_etat*100/sum(ntot_manque_etat), 1),
         `(% type)` = round(ntot_manque_type*100/sum(ntot_manque_type), 1),
         `(% hc)` = round(ntot_manque_hc*100/sum(ntot_manque_hc), 1),
         `(% fpi)` = round(ntot_manque_fpi*100/sum(ntot_manque_fpi), 1),
         `(% atg_l2)` = round(ntot_manque_atg_l2*100/sum(ntot_manque_atg_l2), 1),
         `(% cohe_atg_hc)` = round(ntot_mec_atg_hc*100/sum(ntot_mec_atg_hc), 1),
  )

somme_synth_interreg <- synth_interreg %>%
  summarise_at(c("ntot_ouvrage_analyses", 
                 "ntot_non_valide", 
                 "ntot_manque_op", 
                 "ntot_manque_l2", 
                 "ntot_manque_etat", 
                 "ntot_manque_type", 
                 "ntot_manque_hc", 
                 "ntot_manque_fpi", 
                 "ntot_manque_atg_l2", 
                 "ntot_mec_atg_hc",
                 "(% oa)", 
                 "(% nv)", 
                 "(% op)",
                 "(% l2)",
                 "(% etat)", 
                 "(% type)", 
                 "(% hc)", 
                 "(% fpi)",
                 "(% atg_l2)", 
                 "(% cohe_atg_hc)"), sum, na.rm = TRUE) %>%
  mutate(dept_nom = 'Total inter-DR')

synthese_interregionale <-
  dplyr::bind_rows(synth_interreg, somme_synth_interreg) %>%
  mutate("SD" = dept_nom,
         "Ouvrages analysés" = ntot_ouvrage_analyses, 
         "Ouvrages non-validés" = ntot_non_valide,
         "Manque sur OP" = ntot_manque_op,
         "Manque en L2" = ntot_manque_l2,
         "Manque l'Etat" = ntot_manque_etat, 
         "Manque le type" = ntot_manque_type, 
         "Manque la HC" = ntot_manque_hc,
         "Manque le FPI" = ntot_manque_fpi, 
         "Manque l'ATG en L2" = ntot_manque_atg_l2, 
         "Manque cohérence entre ATG et HC" = ntot_mec_atg_hc) %>%
  select("SD",
         "Ouvrages analysés",  
         "(% oa)", 
         "Ouvrages non-validés", 
         "(% nv)", 
         "Manque sur OP", 
         "(% op)",
         "Manque en L2",
         "(% l2)",
         "Manque l'Etat", 
         "(% etat)", 
         "Manque le type", 
         "(% type)", 
         "Manque la HC",
         "(% hc)", 
         "Manque le FPI", 
         "(% fpi)",
         "Manque l'ATG en L2", 
         "(% atg_l2)", 
         "Manque cohérence entre ATG et HC",
         "(% cohe_atg_hc)",
         -dept_nom, 
         -ntot_ouvrage_analyses, 
         -ntot_non_valide, 
         -ntot_manque_op, 
         -ntot_manque_l2, 
         -ntot_manque_etat, 
         -ntot_manque_type, 
         -ntot_manque_hc, 
         -ntot_manque_fpi, 
         -ntot_manque_atg_l2, 
         -ntot_mec_atg_hc) %>%
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), font_size = 12) %>%
  column_spec(1, bold = T, border_right = T) %>% 
  column_spec(3, color = "grey", italic = T, border_right = T) %>%
  column_spec(5, color = "grey", italic = T, border_right = T) %>%
  column_spec(7, color = "grey", italic = T, border_right = T) %>%
  column_spec(9, color = "grey", italic = T, border_right = T) %>%
  column_spec(11, color = "grey", italic = T, border_right = T) %>%
  column_spec(13, color = "grey", italic = T, border_right = T) %>%
  column_spec(15, color = "grey", italic = T, border_right = T) %>%
  column_spec(17, color = "grey", italic = T, border_right = T) %>%
  column_spec(19, color = "grey", italic = T, border_right = T) %>%
  column_spec(21, color = "grey", italic = T, border_right = T) %>%
  row_spec(10, bold = T, background = "#66CCEE") %>%
  footnote(general = "Les pourcentages représentent la part d'ouvrages du département par rapport à la somme des ouvrages de l'inter-région. ")


synthese_interregionale

synth_reg_bzh <- 
  bdroe %>%
  sf::st_drop_geometry() %>% 
  filter(statut_nom != 'Gelé' & derasement_solde != '1'& dept_code %in% c('22', '29', '35', '56')) %>%
  select(dept_nom, manque_op, manque_l2, manque_etat, manque_type, manque_hc, manque_fip, non_valides, manque_atg_l2, mec_atg_hc) %>%
  as.data.frame() %>%
  group_by(dept_nom) %>%
  sf::st_drop_geometry() %>% 
  dplyr::summarise(ntot_ouvrage_analyses = n(),
            ntot_non_valide = sum(non_valides, na.rm = T), 
            ntot_manque_op = sum(manque_op, na.rm = T),
            ntot_manque_l2 = sum(manque_l2, na.rm = T), 
            ntot_manque_etat = sum(manque_etat, na.rm = T), 
            ntot_manque_type = sum(manque_type, na.rm = T), 
            ntot_manque_hc = sum(manque_hc, na.rm = T), 
            ntot_manque_fpi = sum(manque_fip, na.rm = T),
            ntot_manque_atg_l2 = sum(manque_atg_l2, na.rm = T),
            ntot_mec_atg_hc = sum(mec_atg_hc, na.rm = T)) %>%
  mutate(`(% oa)` = round(ntot_ouvrage_analyses*100/sum(ntot_ouvrage_analyses), 1),
           `(% nv)` = round(ntot_non_valide*100/sum(ntot_non_valide), 1),
           `(% op)` = round(ntot_manque_op*100/sum(ntot_manque_op), 1),
           `(% l2)` = round(ntot_manque_l2*100/sum(ntot_manque_l2), 1),
           `(% etat)` = round(ntot_manque_etat*100/sum(ntot_manque_etat), 1),
           `(% type)` = round(ntot_manque_type*100/sum(ntot_manque_type), 1),
           `(% hc)` = round(ntot_manque_hc*100/sum(ntot_manque_hc), 1),
           `(% fpi)` = round(ntot_manque_fpi*100/sum(ntot_manque_fpi), 1),
           `(% atg_l2)` = round(ntot_manque_atg_l2*100/sum(ntot_manque_atg_l2), 1),
           `(% cohe_atg_hc)` = round(ntot_mec_atg_hc*100/sum(ntot_mec_atg_hc), 1),
  )

somme_synth_reg_bzh <- synth_reg_bzh %>%
  summarise_at(c("ntot_ouvrage_analyses", 
                 "ntot_non_valide", 
                 "ntot_manque_op", 
                 "ntot_manque_l2", 
                 "ntot_manque_etat", 
                 "ntot_manque_type", 
                 "ntot_manque_hc", 
                 "ntot_manque_fpi", 
                 "ntot_manque_atg_l2", 
                 "ntot_mec_atg_hc",
                 "(% oa)", 
                 "(% nv)", 
                 "(% op)",
                 "(% l2)",
                 "(% etat)", 
                 "(% type)", 
                 "(% hc)", 
                 "(% fpi)",
                 "(% atg_l2)", 
                 "(% cohe_atg_hc)"), sum, na.rm = TRUE) %>%
  mutate(dept_nom = 'Total DR Bretagne')

synthese_regionale_bzh <-
  dplyr::bind_rows(synth_reg_bzh, somme_synth_reg_bzh) %>%
  mutate("SD" = dept_nom,
         "Ouvrages analysés" = ntot_ouvrage_analyses, 
         "Ouvrages non-validés" = ntot_non_valide,
         "Manque sur OP" = ntot_manque_op,
         "Manque en L2" = ntot_manque_l2,
         "Manque l'Etat" = ntot_manque_etat, 
         "Manque le type" = ntot_manque_type, 
         "Manque la HC" = ntot_manque_hc,
         "Manque le FPI" = ntot_manque_fpi, 
         "Manque l'ATG en L2" = ntot_manque_atg_l2, 
         "Manque cohérence entre ATG et HC" = ntot_mec_atg_hc) %>%
  select("SD",
         "Ouvrages analysés",  
         "(% oa)", 
         "Ouvrages non-validés", 
         "(% nv)", 
         "Manque sur OP", 
         "(% op)",
         "Manque en L2",
         "(% l2)",
         "Manque l'Etat", 
         "(% etat)", 
         "Manque le type", 
         "(% type)", 
         "Manque la HC",
         "(% hc)", 
         "Manque le FPI", 
         "(% fpi)",
         "Manque l'ATG en L2", 
         "(% atg_l2)", 
         "Manque cohérence entre ATG et HC",
         "(% cohe_atg_hc)",
         -dept_nom, 
         -ntot_ouvrage_analyses, 
         -ntot_non_valide, 
         -ntot_manque_op, 
         -ntot_manque_l2, 
         -ntot_manque_etat, 
         -ntot_manque_type, 
         -ntot_manque_hc, 
         -ntot_manque_fpi, 
         -ntot_manque_atg_l2, 
         -ntot_mec_atg_hc) %>%
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), font_size = 12) %>%
  column_spec(1, bold = T, border_right = T) %>% 
  column_spec(3, color = "grey", italic = T, border_right = T) %>%
  column_spec(5, color = "grey", italic = T, border_right = T) %>%
  column_spec(7, color = "grey", italic = T, border_right = T) %>%
  column_spec(9, color = "grey", italic = T, border_right = T) %>%
  column_spec(11, color = "grey", italic = T, border_right = T) %>%
  column_spec(13, color = "grey", italic = T, border_right = T) %>%
  column_spec(15, color = "grey", italic = T, border_right = T) %>%
  column_spec(17, color = "grey", italic = T, border_right = T) %>%
  column_spec(19, color = "grey", italic = T, border_right = T) %>%
  column_spec(21, color = "grey", italic = T, border_right = T) %>%
  row_spec(5, bold = T, background = "#66CCEE") %>%
  footnote(general = "Les pourcentages représentent la part d'ouvrages du département par rapport à la somme des ouvrages de la région. ")



synthese_regionale_bzh

synth_reg_pdl <- 
  bdroe %>%
  sf::st_drop_geometry() %>% 
  filter(statut_nom != 'Gelé' & derasement_solde != '1'& dept_code %in% c('44', '49', '53', '72', '85')) %>%
  select(dept_nom, manque_op, manque_l2, manque_etat, manque_type, manque_hc, manque_fip, non_valides, manque_atg_l2, mec_atg_hc) %>%
  as.data.frame() %>%
  group_by(dept_nom) %>%
  sf::st_drop_geometry() %>% 
  dplyr::summarise(ntot_ouvrage_analyses = n(),
            ntot_non_valide = sum(non_valides, na.rm = T), 
            ntot_manque_op = sum(manque_op, na.rm = T),
            ntot_manque_l2 = sum(manque_l2, na.rm = T), 
            ntot_manque_etat = sum(manque_etat, na.rm = T), 
            ntot_manque_type = sum(manque_type, na.rm = T), 
            ntot_manque_hc = sum(manque_hc, na.rm = T), 
            ntot_manque_fpi = sum(manque_fip, na.rm = T),
            ntot_manque_atg_l2 = sum(manque_atg_l2, na.rm = T),
            ntot_mec_atg_hc = sum(mec_atg_hc, na.rm = T)) %>%
  mutate(`(% oa)` = round(ntot_ouvrage_analyses*100/sum(ntot_ouvrage_analyses), 1),
         `(% nv)` = round(ntot_non_valide*100/sum(ntot_non_valide), 1),
         `(% op)` = round(ntot_manque_op*100/sum(ntot_manque_op), 1),
         `(% l2)` = round(ntot_manque_l2*100/sum(ntot_manque_l2), 1),
         `(% etat)` = round(ntot_manque_etat*100/sum(ntot_manque_etat), 1),
         `(% type)` = round(ntot_manque_type*100/sum(ntot_manque_type), 1),
         `(% hc)` = round(ntot_manque_hc*100/sum(ntot_manque_hc), 1),
         `(% fpi)` = round(ntot_manque_fpi*100/sum(ntot_manque_fpi), 1),
         `(% atg_l2)` = round(ntot_manque_atg_l2*100/sum(ntot_manque_atg_l2), 1),
         `(% cohe_atg_hc)` = round(ntot_mec_atg_hc*100/sum(ntot_mec_atg_hc), 1),
  )

somme_synth_reg_pdl <- synth_reg_pdl %>%
  summarise_at(c("ntot_ouvrage_analyses", 
                 "ntot_non_valide", 
                 "ntot_manque_op", 
                 "ntot_manque_l2", 
                 "ntot_manque_etat", 
                 "ntot_manque_type", 
                 "ntot_manque_hc", 
                 "ntot_manque_fpi", 
                 "ntot_manque_atg_l2", 
                 "ntot_mec_atg_hc",
                 "(% oa)", 
                 "(% nv)", 
                 "(% op)",
                 "(% l2)",
                 "(% etat)", 
                 "(% type)", 
                 "(% hc)", 
                 "(% fpi)",
                 "(% atg_l2)", 
                 "(% cohe_atg_hc)"), sum, na.rm = TRUE) %>%
  mutate(dept_nom = 'Total DR Pays-de-la-Loire')

synthese_regionale_pdl <-
  dplyr::bind_rows(synth_reg_pdl, somme_synth_reg_pdl) %>%
  mutate("SD" = dept_nom,
         "Ouvrages analysés" = ntot_ouvrage_analyses, 
         "Ouvrages non-validés" = ntot_non_valide,
         "Manque sur OP" = ntot_manque_op,
         "Manque en L2" = ntot_manque_l2,
         "Manque l'Etat" = ntot_manque_etat, 
         "Manque le type" = ntot_manque_type, 
         "Manque la HC" = ntot_manque_hc,
         "Manque le FPI" = ntot_manque_fpi, 
         "Manque l'ATG en L2" = ntot_manque_atg_l2, 
         "Manque cohérence entre ATG et HC" = ntot_mec_atg_hc) %>%
  select("SD",
         "Ouvrages analysés",  
         "(% oa)", 
         "Ouvrages non-validés", 
         "(% nv)", 
         "Manque sur OP", 
         "(% op)",
         "Manque en L2",
         "(% l2)",
         "Manque l'Etat", 
         "(% etat)", 
         "Manque le type", 
         "(% type)", 
         "Manque la HC",
         "(% hc)", 
         "Manque le FPI", 
         "(% fpi)",
         "Manque l'ATG en L2", 
         "(% atg_l2)", 
         "Manque cohérence entre ATG et HC",
         "(% cohe_atg_hc)",
         -dept_nom, 
         -ntot_ouvrage_analyses, 
         -ntot_non_valide, 
         -ntot_manque_op, 
         -ntot_manque_l2, 
         -ntot_manque_etat, 
         -ntot_manque_type, 
         -ntot_manque_hc, 
         -ntot_manque_fpi, 
         -ntot_manque_atg_l2, 
         -ntot_mec_atg_hc) %>%
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), font_size = 12) %>%
  column_spec(1, bold = T, border_right = T) %>% 
  column_spec(3, color = "grey", italic = T, border_right = T) %>%
  column_spec(5, color = "grey", italic = T, border_right = T) %>%
  column_spec(7, color = "grey", italic = T, border_right = T) %>%
  column_spec(9, color = "grey", italic = T, border_right = T) %>%
  column_spec(11, color = "grey", italic = T, border_right = T) %>%
  column_spec(13, color = "grey", italic = T, border_right = T) %>%
  column_spec(15, color = "grey", italic = T, border_right = T) %>%
  column_spec(17, color = "grey", italic = T, border_right = T) %>%
  column_spec(19, color = "grey", italic = T, border_right = T) %>%
  column_spec(21, color = "grey", italic = T, border_right = T) %>%
  row_spec(6, bold = T, background = "#66CCEE") %>%
  footnote(general = "Les pourcentages représentent la part d'ouvrages du département par rapport à la somme des ouvrages de la région. ")

synthese_regionale_pdl

# sauvegardes ----

save(bdroe,
     synthese_regionale_pdl,
     synthese_regionale_bzh,
     synthese_interregionale,
     nb_non_valides,
     nb_manque_etat,
     nb_manque_type,
     nb_manque_hc,
     nb_manque_fip,
     nb_manque_atg_l2,
     nb_manque_op,
     nb_manque_l2,
     nb_ouvrages_prioritaires,
     nb_ouvrages_l2,
     nb_atg_l2,
     nb_mec_atg_hc,
     file = "data/outputs/bdroe.RData")

# Construction de la couche de synthèse par ME -----

me_analyse_manques <- bdroe %>%
  filter(statut_nom != 'Gelé' & derasement_solde != '1' & !is.na(masse_eau_code)) %>%
  sf::st_drop_geometry() %>% 
  mutate(list2 = ifelse(
    classement_liste_2 == 'Oui', 
    1,
    0
  )) %>%
  select(masse_eau_code, ouvrage_prioritaire, list2, manque_op, manque_l2, manque_etat, manque_type, manque_hc, manque_fip, non_valides, manque_atg_l2, mec_atg_hc) %>%
  as.data.frame() %>%
  group_by(masse_eau_code)%>%
  dplyr::summarise(ntot_ouvrages_analyses = n(),
            ntot_ouvrages_prioritaires = sum(ouvrage_prioritaire),
            ntot_ouvrages_l2 = sum(list2),
            ntot_manque_op = sum(manque_op),
            ntot_manque_l2 = sum(manque_l2), 
            ntot_manque_etat = sum(manque_etat), 
            ntot_manque_type = sum(manque_type), 
            ntot_manque_hc = sum(manque_hc), 
            ntot_manque_fip = sum(manque_fip),
            ntot_non_valide = sum(non_valides), 
            ntot_atg_l2 = sum(manque_atg_l2), 
            ntot_mec_atg_hc = sum(mec_atg_hc))

me_analyse_manques2 <- me_analyse_manques %>%
  mutate(masse_eau_code = str_to_upper(masse_eau_code))

me_analyse_manques <- me_analyse_manques2

# Sauvegarder la couche analyse_me ----

sf::write_sf(obj = me_analyse_manques, dsn = "data/outputs/me_analyse_manques_20241201.gpkg")



me_analyse_manques <- bdroe %>%
  filter(
    statut_nom != 'Gelé' & 
      derasement_solde != '1' & 
      !is.na(masse_eau_code) & 
      !is.na(dept_code)   # Ajout de la vérification pour dept_code
  ) %>%
  sf::st_drop_geometry() %>% 
  select(
    identifiant_roe, masse_eau_code, dept_code, 
    manque_op, manque_l2, manque_etat, 
    manque_type, manque_hc, manque_fip, non_valides
  ) %>%
  as.data.frame() %>%
  group_by(masse_eau_code, dept_code) %>%
  summarise(
    ntot_manque_op = sum(manque_op, na.rm = TRUE),
    ntot_manque_l2 = sum(manque_l2, na.rm = TRUE), 
    ntot_manque_etat = sum(manque_etat, na.rm = TRUE), 
    ntot_manque_type = sum(manque_type, na.rm = TRUE), 
    ntot_manque_hc = sum(manque_hc, na.rm = TRUE), 
    ntot_manque_fip = sum(manque_fip, na.rm = TRUE),
    ntot_non_valide = sum(non_valides, na.rm = TRUE)
  )


#good/bof : 
 
me_analyse_manques <- bdroe_dr2_cd_me %>%
  <<<<<<< HEAD
group_by(cdbvspemdo) %>%
  =======
  group_by(cdbvspemdo, na.rm = T) %>%
  >>>>>>> c76f5471a5436169c012e3cc3d5a8ab8ad2ffd7f
summarise(cdbvspemdo = count(cdbvspemdo)) %>%
  mutate(cd_me = cdbvspemdo$x,
         ntot_roe = cdbvspemdo$freq) 



summarise(manque_op = count(manque_op))
as.data.frame()

rm(me_analyse_manques)

nb_total_manque_l2 = sum(manque_l2), 
nb_total_manque_etat = sum(manque_etat), 
nb_total_manque_type = sum(manque_type), 
nb_total_manque_hc = sum(manque_hc), 
nb_total_manque_fip = sum(manque_fip),
nb_total_non_valide = sum(non_valides))

#essais
roe_grp_type <- maj_roe %>%
  group_by(type_nom, na.rm = T) %>%
  summarise(type_nom = count(type_nom))



select(cdbvspemdo, 
       nb_total_manque_op, 
       nb_total_manque_l2, 
       nb_total_manque_etat, 
       nb_total_manque_type, 
       nb_total_manque_hc, 
       nb_total_manque_fip, 
       nb_total_non_valides)


me_stat_manque_bdroe <- masse_eau %>%
  dplyr::left_join(bdroe_dr2_cd_me,
                   by = c("cdbvspemdo" = "cdbvspemdo")) %>%
  select(cdbvspemdo, 
         nb_total_manque_op, 
         nb_total_manque_l2, 
         nb_total_manque_etat, 
         nb_total_manque_type, 
         nb_total_manque_hc, 
         nb_total_manque_fip, 
         nb_total_non_valide)

# fin des essais sur group_by ... de merde ...


# Calcul des variables par département 
# ca BUG - BUG group_by + summarise

bdroe_stat_dept <- bdroe %>%
  sf::st_drop_geometry() %>% 
  filter(statut_nom != 'Gelé' & derasement_solde != '1') %>%
  select(dept_nom, manque_op, manque_l2, manque_etat, manque_type, manque_hc, manque_fip, non_valides, manque_atg_l2, mec_atg_hc, derasement_solde) %>%
  as.data.frame()

bdroe_stat_dept2 <- bdroe_stat_dept %>%
  as.data.frame() %>%
  group_by(dept_nom) %>%
  summarise(ntot_manque_op = sum(manque_op, na.rm = T),
            ntot_manque_l2 = sum(manque_l2, na.rm = T), 
            ntot_manque_etat = sum(manque_etat, na.rm = T), 
            ntot_manque_type = sum(manque_type, na.rm = T), 
            ntot_manque_hc = sum(manque_hc, na.rm = T), 
            ntot_manque_fip = sum(manque_fip, na.rm = T),
            ntot_non_valide = sum(non_valides, na.rm = T), 
            ntot_manque_atg_l2 = sum(manque_atg_l2, na.rm = T),
            ntot_mec_atg_hc = sum(mec_atg_hc, na.rm = T),
            ntot_derasement_solde = sum(derasement_solde, na.rm = T))


# Valorisation régionale de la "BDROE" ----


## Etat ----

bdroe_etat <- bdroe %>%
  select(etat_nom) %>%
  mutate(etat_nom = ifelse((etat_nom == '' | is.na(etat_nom)), "Non-renseigné", etat_nom)) %>%
  group_by(etat_nom) %>%
  summarise() %>%
  st_drop_geometry() %>%
  as.data.frame() %>%
  mutate(etat_nom = fct_relevel(etat_nom,
                                'En projet',  
                                'En construction', 
                                'Existant',
                                'Détruit partiellement',
                                'Détruit entièrement',
                                'Non-renseigné'))

roe_etat_22 <- bdroe %>%
  mutate(etat_nom = ifelse((etat_nom == '' | is.na(etat_nom)), "Non-renseigné", etat_nom)) %>%
  filter(dept_code == '22') %>%
  group_by(etat_nom) %>%
  summarise(nb_22 = n()) %>%
  st_drop_geometry() %>%
  as.data.frame()

roe_etat_29 <- bdroe %>%
  mutate(etat_nom = ifelse((etat_nom == '' | is.na(etat_nom)), "Non-renseigné", etat_nom)) %>%
  filter(dept_code == '29') %>%
  group_by(etat_nom) %>%
  summarise(nb_29 = n()) %>%
  st_drop_geometry() %>%
  as.data.frame()

roe_etat_35 <- bdroe %>%
  mutate(etat_nom = ifelse((etat_nom == '' | is.na(etat_nom)), "Non-renseigné", etat_nom)) %>%
  filter(dept_code == '35') %>%
  group_by(etat_nom) %>%
  summarise(nb_35 = n()) %>%
  st_drop_geometry() %>%
  as.data.frame()

roe_etat_44 <- bdroe %>%
  mutate(etat_nom = ifelse((etat_nom == '' | is.na(etat_nom)), "Non-renseigné", etat_nom)) %>%
  filter(dept_code == '44') %>%
  group_by(etat_nom) %>%
  summarise(nb_44 = n()) %>%
  st_drop_geometry() %>%
  as.data.frame()

roe_etat_49 <- bdroe %>%
  mutate(etat_nom = ifelse((etat_nom == '' | is.na(etat_nom)), "Non-renseigné", etat_nom)) %>%
  filter(dept_code == '49') %>%
  group_by(etat_nom) %>%
  summarise(nb_49 = n()) %>%
  st_drop_geometry() %>%
  as.data.frame()

roe_etat_53 <- bdroe %>%
  mutate(etat_nom = ifelse((etat_nom == '' | is.na(etat_nom)), "Non-renseigné", etat_nom)) %>%
  filter(dept_code == '53') %>%
  group_by(etat_nom) %>%
  summarise(nb_53 = n()) %>%
  st_drop_geometry() %>%
  as.data.frame()

roe_etat_56 <- bdroe %>%
  mutate(etat_nom = ifelse((etat_nom == '' | is.na(etat_nom)), "Non-renseigné", etat_nom)) %>%
  filter(dept_code == '56') %>%
  group_by(etat_nom) %>%
  summarise(nb_56 = n()) %>%
  st_drop_geometry() %>%
  as.data.frame()

roe_etat_72 <- bdroe %>%
  mutate(etat_nom = ifelse((etat_nom == '' | is.na(etat_nom)), "Non-renseigné", etat_nom)) %>%
  filter(dept_code == '72') %>%
  group_by(etat_nom) %>%
  summarise(nb_72 = n()) %>%
  st_drop_geometry() %>%
  as.data.frame()

roe_etat_85 <- bdroe %>%
  mutate(etat_nom = ifelse((etat_nom == '' | is.na(etat_nom)), "Non-renseigné", etat_nom)) %>%
  filter(dept_code == '85') %>%
  group_by(etat_nom) %>%
  summarise(nb_85 = n()) %>%
  st_drop_geometry() %>%
  as.data.frame()

roe_etat_dprt <- bdroe_etat %>%
  left_join(roe_etat_22) %>%
  left_join(roe_etat_29) %>%
  left_join(roe_etat_35) %>%
  left_join(roe_etat_44) %>%
  left_join(roe_etat_49) %>%
  left_join(roe_etat_53) %>%
  left_join(roe_etat_56) %>%
  left_join(roe_etat_72) %>%
  left_join(roe_etat_85)
  
roe_etat_dprt <- roe_etat_dprt %>% 
  mutate(nb_22 = coalesce(nb_22,0)) %>%
  mutate(nb_29 = coalesce(nb_29,0)) %>%
  mutate(nb_35 = coalesce(nb_35,0)) %>%
  mutate(nb_44 = coalesce(nb_44,0)) %>%
  mutate(nb_49 = coalesce(nb_49,0)) %>%
  mutate(nb_53 = coalesce(nb_53,0)) %>%
  mutate(nb_56 = coalesce(nb_56,0)) %>%
  mutate(nb_72 = coalesce(nb_72,0)) %>%
  mutate(nb_85 = coalesce(nb_85,0))%>%
  mutate(etat_nom = fct_relevel(etat_nom,
                              'En projet',  
                              'En construction', 
                              'Existant',
                              'Détruit partiellement',
                              'Détruit entièrement',
                              'Non-renseigné'))

histo_roe_etat <-
  plot_ly(roe_etat_dprt, 
          type = 'bar', 
          y = ~fct_rev(etat_nom), 
          x = ~nb_22, color = I("lightblue"), name = "22") %>%
  add_bars(x = ~nb_29, color = I("#18d0f0"), name = "29") %>% 
  add_bars(x = ~nb_35, color = I("blue"), name = "35") %>% 
  add_bars(x = ~nb_56, color = I("darkblue"), name = "56") %>% 
  add_bars(x = ~nb_44, color = I("pink"), name = "44") %>% 
  add_bars(x = ~nb_49, color = I("violet"), name = "49") %>% 
  add_bars(x = ~nb_53, color = I("orange"), name = "53") %>% 
  add_bars(x = ~nb_72, color = I("red"), name = "72") %>% 
  add_bars(x = ~nb_85, color = I("darkred"), name = "85") %>% 
  layout(yaxis = list(title = "Etat de l'ouvrage"),barmode = 'stack')  %>%
  layout(title = "Répartition des ouvrages selon leur 'Etat'",
         xaxis = list(title = "Nombre d'ouvrages"))

histo_roe_etat_bzh <-
  plot_ly(roe_etat_dprt, 
          type = 'bar', 
          y = ~fct_rev(etat_nom), 
          x = ~nb_22, color = I("lightblue"), name = "22") %>%
  add_bars(x = ~nb_29, color = I("#18d0f0"), name = "29") %>% 
  add_bars(x = ~nb_35, color = I("blue"), name = "35") %>% 
  add_bars(x = ~nb_56, color = I("darkblue"), name = "56") %>% 
  layout(yaxis = list(title = "Etat de l'ouvrage"),barmode = 'stack')  %>%
  layout(title = "Répartition des ouvrages selon leur 'Etat'",
         xaxis = list(title = "Nombre d'ouvrages"))

histo_roe_etat_pdl <-
  plot_ly(roe_etat_dprt, 
          type = 'bar', 
          y = ~fct_rev(etat_nom), 
          x = ~nb_44, color = I("pink"), name = "44") %>% 
  add_bars(x = ~nb_49, color = I("violet"), name = "49") %>% 
  add_bars(x = ~nb_53, color = I("orange"), name = "53") %>% 
  add_bars(x = ~nb_72, color = I("red"), name = "72") %>% 
  add_bars(x = ~nb_85, color = I("darkred"), name = "85") %>% 
  layout(yaxis = list(title = "Etat de l'ouvrage"),barmode = 'stack')  %>%
  layout(title = "Répartition des ouvrages selon leur 'Etat'",
         xaxis = list(title = "Nombre d'ouvrages"))

## Type

bdroe_type <- bdroe %>%
  select(type_nom) %>%
  mutate(type_nom = ifelse((type_nom == '' | is.na(type_nom)), "Non-renseigné", type_nom)) %>%
  group_by(type_nom) %>%
  summarise() %>%
  st_drop_geometry() %>%
  as.data.frame() %>%
  mutate(type_nom = fct_relevel(type_nom,
                                'Barrage',  
                                'Seuil en rivière', 
                                'Obstacle induit par un pont',
                                'Digue',
                                'Epis en rivière',
                                'Grille de pisciculture',
                                'Non-renseigné'))

roe_type_22 <- bdroe %>%
  mutate(type_nom = ifelse((type_nom == '' | is.na(type_nom)), "Non-renseigné", type_nom)) %>%
  filter(dept_code == '22') %>%
  group_by(type_nom) %>%
  summarise(nb_22 = n()) %>%
  st_drop_geometry() %>%
  as.data.frame()

roe_type_29 <- bdroe %>%
  mutate(type_nom = ifelse((type_nom == '' | is.na(type_nom)), "Non-renseigné", type_nom)) %>%
  filter(dept_code == '29') %>%
  group_by(type_nom) %>%
  summarise(nb_29 = n()) %>%
  st_drop_geometry() %>%
  as.data.frame()

roe_type_35 <- bdroe %>%
  mutate(type_nom = ifelse((type_nom == '' | is.na(type_nom)), "Non-renseigné", type_nom)) %>%
  filter(dept_code == '35') %>%
  group_by(type_nom) %>%
  summarise(nb_35 = n()) %>%
  st_drop_geometry() %>%
  as.data.frame()

roe_type_44 <- bdroe %>%
  mutate(type_nom = ifelse((type_nom == '' | is.na(type_nom)), "Non-renseigné", type_nom)) %>%
  filter(dept_code == '44') %>%
  group_by(type_nom) %>%
  summarise(nb_44 = n()) %>%
  st_drop_geometry() %>%
  as.data.frame()

roe_type_49 <- bdroe %>%
  mutate(type_nom = ifelse((type_nom == '' | is.na(type_nom)), "Non-renseigné", type_nom)) %>%
  filter(dept_code == '49') %>%
  group_by(type_nom) %>%
  summarise(nb_49 = n()) %>%
  st_drop_geometry() %>%
  as.data.frame()

roe_type_53 <- bdroe %>%
  mutate(type_nom = ifelse((type_nom == '' | is.na(type_nom)), "Non-renseigné", type_nom)) %>%
  filter(dept_code == '53') %>%
  group_by(type_nom) %>%
  summarise(nb_53 = n()) %>%
  st_drop_geometry() %>%
  as.data.frame()

roe_type_56 <- bdroe %>%
  mutate(type_nom = ifelse((type_nom == '' | is.na(type_nom)), "Non-renseigné", type_nom)) %>%
  filter(dept_code == '56') %>%
  group_by(type_nom) %>%
  summarise(nb_56 = n()) %>%
  st_drop_geometry() %>%
  as.data.frame()

roe_type_72 <- bdroe %>%
  mutate(type_nom = ifelse((type_nom == '' | is.na(type_nom)), "Non-renseigné", type_nom)) %>%
  filter(dept_code == '72') %>%
  group_by(type_nom) %>%
  summarise(nb_72 = n()) %>%
  st_drop_geometry() %>%
  as.data.frame()

roe_type_85 <- bdroe %>%
  mutate(type_nom = ifelse((type_nom == '' | is.na(type_nom)), "Non-renseigné", type_nom)) %>%
  filter(dept_code == '85') %>%
  group_by(type_nom) %>%
  summarise(nb_85 = n()) %>%
  st_drop_geometry() %>%
  as.data.frame()

roe_type_dprt <- bdroe_type %>%
  left_join(roe_type_22) %>%
  left_join(roe_type_29) %>%
  left_join(roe_type_35) %>%
  left_join(roe_type_44) %>%
  left_join(roe_type_49) %>%
  left_join(roe_type_53) %>%
  left_join(roe_type_56) %>%
  left_join(roe_type_72) %>%
  left_join(roe_type_85) 

roe_type_dprt <- roe_type_dprt %>% 
  mutate(nb_22 = coalesce(nb_22,0)) %>%
  mutate(nb_29 = coalesce(nb_29,0)) %>%
  mutate(nb_35 = coalesce(nb_35,0)) %>%
  mutate(nb_44 = coalesce(nb_44,0)) %>%
  mutate(nb_49 = coalesce(nb_49,0)) %>%
  mutate(nb_53 = coalesce(nb_53,0)) %>%
  mutate(nb_56 = coalesce(nb_56,0)) %>%
  mutate(nb_72 = coalesce(nb_72,0)) %>%
  mutate(nb_85 = coalesce(nb_85,0)) %>%
  mutate(type_nom = fct_relevel(type_nom,
                                'Seuil en rivière', 
                                'Barrage',  
                                'Obstacle induit par un pont',
                                'Epis en rivière',
                                'Digue',
                                'Grille de pisciculture',
                                'Non-renseigné'))

histo_roe_type <-
  plot_ly(roe_type_dprt, 
          type = 'bar', 
          y = ~fct_rev(type_nom), 
          x = ~nb_22, color = I("lightblue"), name = "22") %>%
  add_bars(x = ~nb_29, color = I("#18d0f0"), name = "29") %>% 
  add_bars(x = ~nb_35, color = I("blue"), name = "35") %>% 
  add_bars(x = ~nb_56, color = I("darkblue"), name = "56") %>% 
  add_bars(x = ~nb_44, color = I("pink"), name = "44") %>% 
  add_bars(x = ~nb_49, color = I("violet"), name = "49") %>% 
  add_bars(x = ~nb_53, color = I("orange"), name = "53") %>% 
  add_bars(x = ~nb_72, color = I("red"), name = "72") %>% 
  add_bars(x = ~nb_85, color = I("darkred"), name = "85") %>% 
  layout(yaxis = list(title = "Type d'ouvrage"),barmode = 'stack')  %>%
  layout(title = "Répartition des ouvrages selon leur 'Type'",
         xaxis = list(title = "Nombre d'ouvrages"))

histo_roe_type_bzh <-
  plot_ly(roe_type_dprt, 
          type = 'bar', 
          y = ~fct_rev(type_nom), 
          x = ~nb_22, color = I("lightblue"), name = "22") %>%
  add_bars(x = ~nb_29, color = I("#18d0f0"), name = "29") %>% 
  add_bars(x = ~nb_35, color = I("blue"), name = "35") %>% 
  add_bars(x = ~nb_56, color = I("darkblue"), name = "56") %>% 
  layout(yaxis = list(title = "Type d'ouvrage"),barmode = 'stack')  %>%
  layout(title = "Répartition des ouvrages selon leur 'Type'",
         xaxis = list(title = "Nombre d'ouvrages"))

histo_roe_type_pdl <-
  plot_ly(roe_type_dprt, 
          type = 'bar', 
          y = ~fct_rev(type_nom), 
          x =  ~nb_44, color = I("pink"), name = "44") %>% 
  add_bars(x = ~nb_49, color = I("violet"), name = "49") %>% 
  add_bars(x = ~nb_53, color = I("orange"), name = "53") %>% 
  add_bars(x = ~nb_72, color = I("red"), name = "72") %>% 
  add_bars(x = ~nb_85, color = I("darkred"), name = "85") %>% 
  layout(yaxis = list(title = "Type d'ouvrage"),barmode = 'stack')  %>%
  layout(title = "Répartition des ouvrages selon leur 'Type'",
         xaxis = list(title = "Nombre d'ouvrages"))

## Hauteur de chute

bdroe_hc <- bdroe %>%
  select(hauteur_chute_etiage_classe) %>%
  mutate(hauteur_chute_etiage_classe = ifelse((hauteur_chute_etiage_classe == '' | is.na(hauteur_chute_etiage_classe)) | hauteur_chute_etiage_classe == 'Indéterminée', "Non-renseigné", hauteur_chute_etiage_classe)) %>%
  group_by(hauteur_chute_etiage_classe) %>%
  summarise() %>%
  st_drop_geometry() %>%
  as.data.frame() %>%
  mutate(hauteur_chute_etiage_classe = fct_relevel(hauteur_chute_etiage_classe,
                                'Inférieure à 0.5m',  
                                'De 0.5m à inférieure à 1m', 
                                'De 1m à inférieure à 1.5m',
                                'De 1.5m à inférieure à 2m',
                                'De 2m à inférieure à 3m',
                                'De 3m à inférieure à 5m',
                                'De 5m à inférieure à 10m',
                                'Supérieure ou égale à 10m',
                                'Non-renseigné'))

roe_hc_22 <- bdroe %>%
  mutate(hauteur_chute_etiage_classe = ifelse((hauteur_chute_etiage_classe == '' | is.na(hauteur_chute_etiage_classe)) | hauteur_chute_etiage_classe == 'Indéterminée', "Non-renseigné", hauteur_chute_etiage_classe)) %>%
  filter(dept_code == '22') %>%
  group_by(hauteur_chute_etiage_classe) %>%
  summarise(nb_22 = n()) %>%
  st_drop_geometry() %>%
  as.data.frame()

roe_hc_29 <- bdroe %>%
  mutate(hauteur_chute_etiage_classe = ifelse((hauteur_chute_etiage_classe == '' | is.na(hauteur_chute_etiage_classe)) | hauteur_chute_etiage_classe == 'Indéterminée', "Non-renseigné", hauteur_chute_etiage_classe)) %>%
  filter(dept_code == '29') %>%
  group_by(hauteur_chute_etiage_classe) %>%
  summarise(nb_29 = n()) %>%
  st_drop_geometry() %>%
  as.data.frame()

roe_hc_35 <- bdroe %>%
  mutate(hauteur_chute_etiage_classe = ifelse((hauteur_chute_etiage_classe == '' | is.na(hauteur_chute_etiage_classe)) | hauteur_chute_etiage_classe == 'Indéterminée', "Non-renseigné", hauteur_chute_etiage_classe)) %>%
  filter(dept_code == '35') %>%
  group_by(hauteur_chute_etiage_classe) %>%
  summarise(nb_35 = n()) %>%
  st_drop_geometry() %>%
  as.data.frame()

roe_hc_44 <- bdroe %>%
  mutate(hauteur_chute_etiage_classe = ifelse((hauteur_chute_etiage_classe == '' | is.na(hauteur_chute_etiage_classe)) | hauteur_chute_etiage_classe == 'Indéterminée', "Non-renseigné", hauteur_chute_etiage_classe)) %>%
  filter(dept_code == '44') %>%
  group_by(hauteur_chute_etiage_classe) %>%
  summarise(nb_44 = n()) %>%
  st_drop_geometry() %>%
  as.data.frame()

roe_hc_49 <- bdroe %>%
  mutate(hauteur_chute_etiage_classe = ifelse((hauteur_chute_etiage_classe == '' | is.na(hauteur_chute_etiage_classe)) | hauteur_chute_etiage_classe == 'Indéterminée', "Non-renseigné", hauteur_chute_etiage_classe)) %>%
  filter(dept_code == '49') %>%
  group_by(hauteur_chute_etiage_classe) %>%
  summarise(nb_49 = n()) %>%
  st_drop_geometry() %>%
  as.data.frame()

roe_hc_53 <- bdroe %>%
  mutate(hauteur_chute_etiage_classe = ifelse((hauteur_chute_etiage_classe == '' | is.na(hauteur_chute_etiage_classe)) | hauteur_chute_etiage_classe == 'Indéterminée', "Non-renseigné", hauteur_chute_etiage_classe)) %>%
  filter(dept_code == '53') %>%
  group_by(hauteur_chute_etiage_classe) %>%
  summarise(nb_53 = n()) %>%
  st_drop_geometry() %>%
  as.data.frame()

roe_hc_56 <- bdroe %>%
  mutate(hauteur_chute_etiage_classe = ifelse((hauteur_chute_etiage_classe == '' | is.na(hauteur_chute_etiage_classe)) | hauteur_chute_etiage_classe == 'Indéterminée', "Non-renseigné", hauteur_chute_etiage_classe)) %>%
  filter(dept_code == '56') %>%
  group_by(hauteur_chute_etiage_classe) %>%
  summarise(nb_56 = n()) %>%
  st_drop_geometry() %>%
  as.data.frame()

roe_hc_72 <- bdroe %>%
  mutate(hauteur_chute_etiage_classe = ifelse((hauteur_chute_etiage_classe == '' | is.na(hauteur_chute_etiage_classe)) | hauteur_chute_etiage_classe == 'Indéterminée', "Non-renseigné", hauteur_chute_etiage_classe)) %>%
  filter(dept_code == '72') %>%
  group_by(hauteur_chute_etiage_classe) %>%
  summarise(nb_72 = n()) %>%
  st_drop_geometry() %>%
  as.data.frame()

roe_hc_85 <- bdroe %>%
  mutate(hauteur_chute_etiage_classe = ifelse((hauteur_chute_etiage_classe == '' | is.na(hauteur_chute_etiage_classe)) | hauteur_chute_etiage_classe == 'Indéterminée', "Non-renseigné", hauteur_chute_etiage_classe)) %>%
  filter(dept_code == '85') %>%
  group_by(hauteur_chute_etiage_classe) %>%
  summarise(nb_85 = n()) %>%
  st_drop_geometry() %>%
  as.data.frame()

roe_hc_dprt <- bdroe_hc %>%
  left_join(roe_hc_22) %>%
  left_join(roe_hc_29) %>%
  left_join(roe_hc_35) %>%
  left_join(roe_hc_44) %>%
  left_join(roe_hc_49) %>%
  left_join(roe_hc_53) %>%
  left_join(roe_hc_56) %>%
  left_join(roe_hc_72) %>%
  left_join(roe_hc_85) 

roe_hc_dprt <- roe_hc_dprt %>% 
  mutate(nb_22 = coalesce(nb_22,0)) %>%
  mutate(nb_29 = coalesce(nb_29,0)) %>%
  mutate(nb_35 = coalesce(nb_35,0)) %>%
  mutate(nb_44 = coalesce(nb_44,0)) %>%
  mutate(nb_49 = coalesce(nb_49,0)) %>%
  mutate(nb_53 = coalesce(nb_53,0)) %>%
  mutate(nb_56 = coalesce(nb_56,0)) %>%
  mutate(nb_72 = coalesce(nb_72,0)) %>%
  mutate(nb_85 = coalesce(nb_85,0)) %>%
  mutate(hauteur_chute_etiage_classe = fct_relevel(hauteur_chute_etiage_classe,
                                                   'Inférieure à 0.5m',  
                                                   'De 0.5m à inférieure à 1m', 
                                                   'De 1m à inférieure à 1.5m',
                                                   'De 1.5m à inférieure à 2m',
                                                   'De 2m à inférieure à 3m',
                                                   'De 3m à inférieure à 5m',
                                                   'De 5m à inférieure à 10m',
                                                   'Supérieure ou égale à 10m',
                                                   'Non-renseigné'))

histo_roe_hc <-
  plot_ly(roe_hc_dprt, 
          type = 'bar', 
          y = ~fct_rev(hauteur_chute_etiage_classe), 
          x = ~nb_22, color = I("lightblue"), name = "22") %>%
  add_bars(x = ~nb_29, color = I("#18d0f0"), name = "29") %>% 
  add_bars(x = ~nb_35, color = I("blue"), name = "35") %>% 
  add_bars(x = ~nb_56, color = I("darkblue"), name = "56") %>% 
  add_bars(x = ~nb_44, color = I("pink"), name = "44") %>% 
  add_bars(x = ~nb_49, color = I("violet"), name = "49") %>% 
  add_bars(x = ~nb_53, color = I("orange"), name = "53") %>% 
  add_bars(x = ~nb_72, color = I("red"), name = "72") %>% 
  add_bars(x = ~nb_85, color = I("darkred"), name = "85") %>% 
  layout(yaxis = list(title = "Classes de hauteur de chute"),barmode = 'stack')  %>%
  layout(title = "Répartition des ouvrages selon leur 'Hauteur de chute'",
         xaxis = list(title = "Nombre d'ouvrages"))

histo_roe_hc_bzh <-
  plot_ly(roe_hc_dprt, 
          type = 'bar', 
          y = ~fct_rev(hauteur_chute_etiage_classe), 
          x = ~nb_22, color = I("lightblue"), name = "22") %>%
  add_bars(x = ~nb_29, color = I("#18d0f0"), name = "29") %>% 
  add_bars(x = ~nb_35, color = I("blue"), name = "35") %>% 
  add_bars(x = ~nb_56, color = I("darkblue"), name = "56") %>% 
  layout(yaxis = list(title = "Classes de hauteur de chute"),barmode = 'stack')  %>%
  layout(title = "Répartition des ouvrages selon leur 'Hauteur de chute'",
         xaxis = list(title = "Nombre d'ouvrages"))

histo_roe_hc_pdl <-
  plot_ly(roe_hc_dprt, 
          type = 'bar', 
          y = ~fct_rev(hauteur_chute_etiage_classe), 
          x = ~nb_44, color = I("pink"), name = "44") %>% 
  add_bars(x = ~nb_49, color = I("violet"), name = "49") %>% 
  add_bars(x = ~nb_53, color = I("orange"), name = "53") %>% 
  add_bars(x = ~nb_72, color = I("red"), name = "72") %>% 
  add_bars(x = ~nb_85, color = I("darkred"), name = "85") %>% 
  layout(yaxis = list(title = "Classes de hauteur de chute"),barmode = 'stack')  %>%
  layout(title = "Répartition des ouvrages selon leur 'Hauteur de chute'",
         xaxis = list(title = "Nombre d'ouvrages"))

#diag_hc <-
  ggplot(data = bdroe_dr2_valid, 
       aes(y = ifelse(hauteur_chute_etiage_classe == '', "Non-renseigné", hauteur_chute_etiage_classe))) +
  geom_bar(fill = "lightblue") +
  labs(y = "Hauteur de chute",
       x = "Nombre d'ouvrages",
       title = "Hauteur de chute des ouvrages connus en Bretagne et Pays-de-la-Loire")

## FPI

  bdroe_fpi <- bdroe %>%
    select(fpi_nom1) %>%
    mutate(fpi_nom1 = ifelse((fpi_nom1 == '' | is.na(fpi_nom1)), "Non-renseigné", fpi_nom1)) %>%
    group_by(fpi_nom1) %>%
    summarise() %>%
    st_drop_geometry() %>%
    as.data.frame() 
  
  roe_fpi_22 <- bdroe %>%
    mutate(fpi_nom1 = ifelse((fpi_nom1 == '' | is.na(fpi_nom1)), "Non-renseigné", fpi_nom1)) %>%
    filter(dept_code == '22') %>%
    group_by(fpi_nom1) %>%
    summarise(nb_22 = n()) %>%
    st_drop_geometry() %>%
    as.data.frame()
  
  roe_fpi_29 <- bdroe %>%
    mutate(fpi_nom1 = ifelse((fpi_nom1 == '' | is.na(fpi_nom1)), "Non-renseigné", fpi_nom1)) %>%
    filter(dept_code == '29') %>%
    group_by(fpi_nom1) %>%
    summarise(nb_29 = n()) %>%
    st_drop_geometry() %>%
    as.data.frame()
  
  roe_fpi_35 <- bdroe %>%
    mutate(fpi_nom1 = ifelse((fpi_nom1 == '' | is.na(fpi_nom1)), "Non-renseigné", fpi_nom1)) %>%
    filter(dept_code == '35') %>%
    group_by(fpi_nom1) %>%
    summarise(nb_35 = n()) %>%
    st_drop_geometry() %>%
    as.data.frame()
  
  roe_fpi_44 <- bdroe %>%
    mutate(fpi_nom1 = ifelse((fpi_nom1 == '' | is.na(fpi_nom1)), "Non-renseigné", fpi_nom1)) %>%
    filter(dept_code == '44') %>%
    group_by(fpi_nom1) %>%
    summarise(nb_44 = n()) %>%
    st_drop_geometry() %>%
    as.data.frame()
  
  roe_fpi_49 <- bdroe %>%
    mutate(fpi_nom1 = ifelse((fpi_nom1 == '' | is.na(fpi_nom1)), "Non-renseigné", fpi_nom1)) %>%
    filter(dept_code == '49') %>%
    group_by(fpi_nom1) %>%
    summarise(nb_49 = n()) %>%
    st_drop_geometry() %>%
    as.data.frame()
  
  roe_fpi_53 <- bdroe %>%
    mutate(fpi_nom1 = ifelse((fpi_nom1 == '' | is.na(fpi_nom1)), "Non-renseigné", fpi_nom1)) %>%
    filter(dept_code == '53') %>%
    group_by(fpi_nom1) %>%
    summarise(nb_53 = n()) %>%
    st_drop_geometry() %>%
    as.data.frame()
  
  roe_fpi_56 <- bdroe %>%
    mutate(fpi_nom1 = ifelse((fpi_nom1 == '' | is.na(fpi_nom1)), "Non-renseigné", fpi_nom1)) %>%
    filter(dept_code == '56') %>%
    group_by(fpi_nom1) %>%
    summarise(nb_56 = n()) %>%
    st_drop_geometry() %>%
    as.data.frame()
  
  roe_fpi_72 <- bdroe %>%
    mutate(fpi_nom1 = ifelse((fpi_nom1 == '' | is.na(fpi_nom1)), "Non-renseigné", fpi_nom1)) %>%
    filter(dept_code == '72') %>%
    group_by(fpi_nom1) %>%
    summarise(nb_72 = n()) %>%
    st_drop_geometry() %>%
    as.data.frame()
  
  roe_fpi_85 <- bdroe %>%
    mutate(fpi_nom1 = ifelse((fpi_nom1 == '' | is.na(fpi_nom1)), "Non-renseigné", fpi_nom1)) %>%
    filter(dept_code == '85') %>%
    group_by(fpi_nom1) %>%
    summarise(nb_85 = n()) %>%
    st_drop_geometry() %>%
    as.data.frame()
  
  roe_fpi_dprt <- bdroe_fpi %>%
    left_join(roe_fpi_22) %>%
    left_join(roe_fpi_29) %>%
    left_join(roe_fpi_35) %>%
    left_join(roe_fpi_44) %>%
    left_join(roe_fpi_49) %>%
    left_join(roe_fpi_53) %>%
    left_join(roe_fpi_56) %>%
    left_join(roe_fpi_72) %>%
    left_join(roe_fpi_85)
  
  roe_fpi_dprt <- roe_fpi_dprt %>% 
    mutate(nb_22 = coalesce(nb_22,0)) %>%
    mutate(nb_29 = coalesce(nb_29,0)) %>%
    mutate(nb_35 = coalesce(nb_35,0)) %>%
    mutate(nb_44 = coalesce(nb_44,0)) %>%
    mutate(nb_49 = coalesce(nb_49,0)) %>%
    mutate(nb_53 = coalesce(nb_53,0)) %>%
    mutate(nb_56 = coalesce(nb_56,0)) %>%
    mutate(nb_72 = coalesce(nb_72,0)) %>%
    mutate(nb_85 = coalesce(nb_85,0)) %>%
    mutate(fpi_nom1 = fct_relevel(fpi_nom1,
                                  'Absence de passe',  
                                  'Ascenseur à poisson', 
                                  'Ecluse à poisson',
                                  'Exutoire de dévalaison',
                                  'Passe à Anguille',
                                  'Passe à bassins successifs',
                                  'Passe à ralentisseurs',
                                  'Pré-barrage',
                                  'Rampe',
                                  'Rivière de contournement',
                                  'Autre type de passe',
                                  'Type de dispositif (piscicole) inconnu',
                                  'Non-renseigné'))
  
  histo_roe_fpi <-
    plot_ly(roe_fpi_dprt, 
            type = 'bar', 
            y = ~fct_rev(fpi_nom1), 
            x = ~nb_22, color = I("lightblue"), name = "22") %>%
    add_bars(x = ~nb_29, color = I("#18d0f0"), name = "29") %>% 
    add_bars(x = ~nb_35, color = I("blue"), name = "35") %>% 
    add_bars(x = ~nb_56, color = I("darkblue"), name = "56") %>% 
    add_bars(x = ~nb_44, color = I("pink"), name = "44") %>% 
    add_bars(x = ~nb_49, color = I("violet"), name = "49") %>% 
    add_bars(x = ~nb_53, color = I("orange"), name = "53") %>% 
    add_bars(x = ~nb_72, color = I("red"), name = "72") %>% 
    add_bars(x = ~nb_85, color = I("darkred"), name = "85") %>% 
    layout(yaxis = list(title = "Type de franchissement piscicole"),barmode = 'stack')  %>%
    layout(title = "Répartition des ouvrages selon leur 'Dispositif de franchissement piscicole'",
           xaxis = list(title = "Nombre d'ouvrages"))
  
  histo_roe_fpi_bzh <-
    plot_ly(roe_fpi_dprt, 
            type = 'bar', 
            y = ~fct_rev(fpi_nom1), 
            x = ~nb_22, color = I("lightblue"), name = "22") %>%
    add_bars(x = ~nb_29, color = I("#18d0f0"), name = "29") %>% 
    add_bars(x = ~nb_35, color = I("blue"), name = "35") %>% 
    add_bars(x = ~nb_56, color = I("darkblue"), name = "56") %>% 
    layout(yaxis = list(title = "Type de franchissement piscicole"),barmode = 'stack')  %>%
    layout(title = "Répartition des ouvrages selon leur 'Dispositif de franchissement piscicole'",
           xaxis = list(title = "Nombre d'ouvrages"))
  
  histo_roe_fpi_pdl <-
    plot_ly(roe_fpi_dprt, 
            type = 'bar', 
            y = ~fct_rev(fpi_nom1), 
            x = ~nb_44, color = I("pink"), name = "44") %>% 
    add_bars(x = ~nb_49, color = I("violet"), name = "49") %>% 
    add_bars(x = ~nb_53, color = I("orange"), name = "53") %>% 
    add_bars(x = ~nb_72, color = I("red"), name = "72") %>% 
    add_bars(x = ~nb_85, color = I("darkred"), name = "85") %>% 
    layout(yaxis = list(title = "Type de franchissement piscicole"),barmode = 'stack')  %>%
    layout(title = "Répartition des ouvrages selon leur 'Dispositif de franchissement piscicole'",
           xaxis = list(title = "Nombre d'ouvrages"))
  
#diag_fpi <-
  ggplot(data = bdroe_dr2_valid, 
       aes(x = ifelse(fpi_nom1 == '', "Non-renseigné", fpi_nom1))) +
  geom_bar(fill = "lightblue") +
  coord_flip() +
  labs(x = "Type de franchissement piscicole",
       y = "Nombre d'ouvrages",
       title = "Type de franchissement piscicole des ouvrages connus en Bretagne et Pays-de-la-Loire")

## ATG

  bdroe_atg <- bdroe %>%
    select(avis_technique_global) %>%
    mutate(avis_technique_global = ifelse((avis_technique_global == '' | is.na(avis_technique_global)), "Non-renseigné", avis_technique_global)) %>%
    group_by(avis_technique_global) %>%
    summarise() %>%
    st_drop_geometry() %>%
    as.data.frame() %>%
  mutate(avis_technique_global = fct_relevel(avis_technique_global,
                                'Positif',  
                                'Incertain', 
                                'Négatif',
                                'Non-renseigné'))
  
  roe_atg_22 <- bdroe %>%
    mutate(avis_technique_global = ifelse((avis_technique_global == '' | is.na(avis_technique_global)), "Non-renseigné", avis_technique_global)) %>%
    filter(dept_code == '22') %>%
    group_by(avis_technique_global) %>%
    summarise(nb_22 = n()) %>%
    st_drop_geometry() %>%
    as.data.frame()
  
  roe_atg_29 <- bdroe %>%
    mutate(avis_technique_global = ifelse((avis_technique_global == '' | is.na(avis_technique_global)), "Non-renseigné", avis_technique_global)) %>%
    filter(dept_code == '29') %>%
    group_by(avis_technique_global) %>%
    summarise(nb_29 = n()) %>%
    st_drop_geometry() %>%
    as.data.frame()
  
  roe_atg_35 <- bdroe %>%
    mutate(avis_technique_global = ifelse((avis_technique_global == '' | is.na(avis_technique_global)), "Non-renseigné", avis_technique_global)) %>%
    filter(dept_code == '35') %>%
    group_by(avis_technique_global) %>%
    summarise(nb_35 = n()) %>%
    st_drop_geometry() %>%
    as.data.frame()
  
  roe_atg_44 <- bdroe %>%
    mutate(avis_technique_global = ifelse((avis_technique_global == '' | is.na(avis_technique_global)), "Non-renseigné", avis_technique_global)) %>%
    filter(dept_code == '44') %>%
    group_by(avis_technique_global) %>%
    summarise(nb_44 = n()) %>%
    st_drop_geometry() %>%
    as.data.frame()
  
  roe_atg_49 <- bdroe %>%
    mutate(avis_technique_global = ifelse((avis_technique_global == '' | is.na(avis_technique_global)), "Non-renseigné", avis_technique_global)) %>%
    filter(dept_code == '49') %>%
    group_by(avis_technique_global) %>%
    summarise(nb_49 = n()) %>%
    st_drop_geometry() %>%
    as.data.frame()
  
  roe_atg_53 <- bdroe %>%
    mutate(avis_technique_global = ifelse((avis_technique_global == '' | is.na(avis_technique_global)), "Non-renseigné", avis_technique_global)) %>%
    filter(dept_code == '53') %>%
    group_by(avis_technique_global) %>%
    summarise(nb_53 = n()) %>%
    st_drop_geometry() %>%
    as.data.frame()
  
  roe_atg_56 <- bdroe %>%
    mutate(avis_technique_global = ifelse((avis_technique_global == '' | is.na(avis_technique_global)), "Non-renseigné", avis_technique_global)) %>%
    filter(dept_code == '56') %>%
    group_by(avis_technique_global) %>%
    summarise(nb_56 = n()) %>%
    st_drop_geometry() %>%
    as.data.frame()
  
  roe_atg_72 <- bdroe %>%
    mutate(avis_technique_global = ifelse((avis_technique_global == '' | is.na(avis_technique_global)), "Non-renseigné", avis_technique_global)) %>%
    filter(dept_code == '72') %>%
    group_by(avis_technique_global) %>%
    summarise(nb_72 = n()) %>%
    st_drop_geometry() %>%
    as.data.frame()
  
  roe_atg_85 <- bdroe %>%
    mutate(avis_technique_global = ifelse((avis_technique_global == '' | is.na(avis_technique_global)), "Non-renseigné", avis_technique_global)) %>%
    filter(dept_code == '85') %>%
    group_by(avis_technique_global) %>%
    summarise(nb_85 = n()) %>%
    st_drop_geometry() %>%
    as.data.frame()
  
  roe_atg_dprt <- bdroe_atg %>%
    left_join(roe_atg_22) %>%
    left_join(roe_atg_29) %>%
    left_join(roe_atg_35) %>%
    left_join(roe_atg_44) %>%
    left_join(roe_atg_49) %>%
    left_join(roe_atg_53) %>%
    left_join(roe_atg_56) %>%
    left_join(roe_atg_72) %>%
    left_join(roe_atg_85)
  
  roe_atg_dprt <- roe_atg_dprt %>% 
    mutate(nb_22 = coalesce(nb_22,0)) %>%
    mutate(nb_29 = coalesce(nb_29,0)) %>%
    mutate(nb_35 = coalesce(nb_35,0)) %>%
    mutate(nb_44 = coalesce(nb_44,0)) %>%
    mutate(nb_49 = coalesce(nb_49,0)) %>%
    mutate(nb_53 = coalesce(nb_53,0)) %>%
    mutate(nb_56 = coalesce(nb_56,0)) %>%
    mutate(nb_72 = coalesce(nb_72,0)) %>%
    mutate(nb_85 = coalesce(nb_85,0)) %>%
    mutate(avis_technique_global = fct_relevel(avis_technique_global,
                                               'Positif',  
                                               'Incertain', 
                                               'Négatif',
                                               'Non-renseigné'))
histo_roe_atg <-
    plot_ly(roe_atg_dprt, 
            type = 'bar', 
            y = ~fct_rev(avis_technique_global), 
            x = ~nb_22, color = I("lightblue"), name = "22") %>%
    add_bars(x = ~nb_29, color = I("#18d0f0"), name = "29") %>% 
    add_bars(x = ~nb_35, color = I("blue"), name = "35") %>% 
    add_bars(x = ~nb_56, color = I("darkblue"), name = "56") %>% 
    add_bars(x = ~nb_44, color = I("pink"), name = "44") %>% 
    add_bars(x = ~nb_49, color = I("violet"), name = "49") %>% 
    add_bars(x = ~nb_53, color = I("orange"), name = "53") %>% 
    add_bars(x = ~nb_72, color = I("red"), name = "72") %>% 
    add_bars(x = ~nb_85, color = I("darkred"), name = "85") %>% 
    layout(yaxis = list(title = "Avis technique global de franchissabilité"),barmode = 'stack')  %>%
    layout(title = "Répartition des ouvrages selon leur 'Avis Technique Global (ATG) de franchissabilité'",
           xaxis = list(title = "Nombre d'ouvrages"))

histo_roe_atg_bzh <-
  plot_ly(roe_atg_dprt, 
          type = 'bar', 
          y = ~fct_rev(avis_technique_global), 
          x = ~nb_22, color = I("lightblue"), name = "22") %>%
  add_bars(x = ~nb_29, color = I("#18d0f0"), name = "29") %>% 
  add_bars(x = ~nb_35, color = I("blue"), name = "35") %>% 
  add_bars(x = ~nb_56, color = I("darkblue"), name = "56") %>% 
  layout(yaxis = list(title = "Avis technique global de franchissabilité"),barmode = 'stack')  %>%
  layout(title = "Répartition des ouvrages selon leur 'Avis Technique Global (ATG) de franchissabilité'",
         xaxis = list(title = "Nombre d'ouvrages"))

histo_roe_atg_pdl <-
  plot_ly(roe_atg_dprt, 
          type = 'bar', 
          y = ~fct_rev(avis_technique_global), 
          x = ~nb_44, color = I("pink"), name = "44") %>% 
  add_bars(x = ~nb_49, color = I("violet"), name = "49") %>% 
  add_bars(x = ~nb_53, color = I("orange"), name = "53") %>% 
  add_bars(x = ~nb_72, color = I("red"), name = "72") %>% 
  add_bars(x = ~nb_85, color = I("darkred"), name = "85") %>% 
  layout(yaxis = list(title = "Avis technique global de franchissabilité"),barmode = 'stack')  %>%
  layout(title = "Répartition des ouvrages selon leur 'Avis Technique Global (ATG) de franchissabilité'",
         xaxis = list(title = "Nombre d'ouvrages"))
  
#diag_atg<-
  ggplot(data = bdroe_dr2_valid, 
       aes(x = ifelse(coalesce(avis_technique_global, '') == '', "Non-renseigné", avis_technique_global))) +
  geom_bar(fill = "lightblue") +
  coord_flip() +
  labs(x = "ATG",
       y = "Nombre d'ouvrages",
       title = "Avis Technique Global des ouvrages connus en Bretagne et Pays-de-la-Loire")

## Usages

bdroe_usage <- bdroe %>%
  select(usage_nom1) %>%
  mutate(usage_nom1 = ifelse((usage_nom1 == '' | is.na(usage_nom1)), "Non-renseigné", usage_nom1)) %>%
  group_by(usage_nom1) %>%
  summarise() %>%
  st_drop_geometry() %>%
  as.data.frame() %>%
  mutate(usage_nom1 = fct_relevel(usage_nom1,
                                  "Aucun",           
                                  "Activités aquacoles",  
                                  "Agriculture (irrigation, abreuvage)", 
                                  "Alimentation en eau potable",
                                  "Energie et hydroélectricité",
                                  "Industrie",
                                  "Loisirs et sports aquatiques",
                                  "Obsolète",
                                  "Stabilisation du profil en long du lit, lutte contre l'érosion",
                                  "Suivi technique et scientifique (débit, température)",
                                  "Sécurité des biens et des personnes",
                                  "Transports et soutien de navigation",
                                  "Type d'usage inconnu",
                                  "Non-renseigné"))

roe_usage_22 <- bdroe %>%
  mutate(usage_nom1 = ifelse((usage_nom1 == '' | is.na(usage_nom1)), "Non-renseigné", usage_nom1)) %>%
  filter(dept_code == '22') %>%
  group_by(usage_nom1) %>%
  summarise(nb_22 = n()) %>%
  st_drop_geometry() %>%
  as.data.frame()

roe_usage_29 <- bdroe %>%
  mutate(usage_nom1 = ifelse((usage_nom1 == '' | is.na(usage_nom1)), "Non-renseigné", usage_nom1)) %>%
  filter(dept_code == '29') %>%
  group_by(usage_nom1) %>%
  summarise(nb_29 = n()) %>%
  st_drop_geometry() %>%
  as.data.frame()

roe_usage_35 <- bdroe %>%
  mutate(usage_nom1 = ifelse((usage_nom1 == '' | is.na(usage_nom1)), "Non-renseigné", usage_nom1)) %>%
  filter(dept_code == '35') %>%
  group_by(usage_nom1) %>%
  summarise(nb_35 = n()) %>%
  st_drop_geometry() %>%
  as.data.frame()

roe_usage_44 <- bdroe %>%
  mutate(usage_nom1 = ifelse((usage_nom1 == '' | is.na(usage_nom1)), "Non-renseigné", usage_nom1)) %>%
  filter(dept_code == '44') %>%
  group_by(usage_nom1) %>%
  summarise(nb_44 = n()) %>%
  st_drop_geometry() %>%
  as.data.frame()

roe_usage_49 <- bdroe %>%
  mutate(usage_nom1 = ifelse((usage_nom1 == '' | is.na(usage_nom1)), "Non-renseigné", usage_nom1)) %>%
  filter(dept_code == '49') %>%
  group_by(usage_nom1) %>%
  summarise(nb_49 = n()) %>%
  st_drop_geometry() %>%
  as.data.frame()

roe_usage_53 <- bdroe %>%
  mutate(usage_nom1 = ifelse((usage_nom1 == '' | is.na(usage_nom1)), "Non-renseigné", usage_nom1)) %>%
  filter(dept_code == '53') %>%
  group_by(usage_nom1) %>%
  summarise(nb_53 = n()) %>%
  st_drop_geometry() %>%
  as.data.frame()

roe_usage_56 <- bdroe %>%
  mutate(usage_nom1 = ifelse((usage_nom1 == '' | is.na(usage_nom1)), "Non-renseigné", usage_nom1)) %>%
  filter(dept_code == '56') %>%
  group_by(usage_nom1) %>%
  summarise(nb_56 = n()) %>%
  st_drop_geometry() %>%
  as.data.frame()

roe_usage_72 <- bdroe %>%
  mutate(usage_nom1 = ifelse((usage_nom1 == '' | is.na(usage_nom1)), "Non-renseigné", usage_nom1)) %>%
  filter(dept_code == '72') %>%
  group_by(usage_nom1) %>%
  summarise(nb_72 = n()) %>%
  st_drop_geometry() %>%
  as.data.frame()

roe_usage_85 <- bdroe %>%
  mutate(usage_nom1 = ifelse((usage_nom1 == '' | is.na(usage_nom1)), "Non-renseigné", usage_nom1)) %>%
  filter(dept_code == '85') %>%
  group_by(usage_nom1) %>%
  summarise(nb_85 = n()) %>%
  st_drop_geometry() %>%
  as.data.frame()

roe_usage_dprt <- bdroe_usage %>%
  left_join(roe_usage_22) %>%
  left_join(roe_usage_29) %>%
  left_join(roe_usage_35) %>%
  left_join(roe_usage_44) %>%
  left_join(roe_usage_49) %>%
  left_join(roe_usage_53) %>%
  left_join(roe_usage_56) %>%
  left_join(roe_usage_72) %>%
  left_join(roe_usage_85)

roe_usage_dprt <- roe_usage_dprt %>% 
  mutate(nb_22 = coalesce(nb_22,0)) %>%
  mutate(nb_29 = coalesce(nb_29,0)) %>%
  mutate(nb_35 = coalesce(nb_35,0)) %>%
  mutate(nb_44 = coalesce(nb_44,0)) %>%
  mutate(nb_49 = coalesce(nb_49,0)) %>%
  mutate(nb_53 = coalesce(nb_53,0)) %>%
  mutate(nb_56 = coalesce(nb_56,0)) %>%
  mutate(nb_72 = coalesce(nb_72,0)) %>%
  mutate(nb_85 = coalesce(nb_85,0)) %>%
  mutate(usage_nom1 = fct_relevel(usage_nom1,
                                  "Aucun",           
                                  "Activités aquacoles",  
                                  "Agriculture (irrigation, abreuvage)", 
                                  "Alimentation en eau potable",
                                  "Energie et hydroélectricité",
                                  "Industrie",
                                  "Loisirs et sports aquatiques",
                                  "Obsolète",
                                  "Stabilisation du profil en long du lit, lutte contre l'érosion",
                                  "Suivi technique et scientifique (débit, température)",
                                  "Sécurité des biens et des personnes",
                                  "Transports et soutien de navigation",
                                  "Type d'usage inconnu",
                                  "Non-renseigné"))
histo_roe_usage <-
  plot_ly(roe_usage_dprt, 
          type = 'bar', 
          y = ~fct_rev(usage_nom1), 
          x = ~nb_22, color = I("lightblue"), name = "22") %>%
  add_bars(x = ~nb_29, color = I("#18d0f0"), name = "29") %>% 
  add_bars(x = ~nb_35, color = I("blue"), name = "35") %>% 
  add_bars(x = ~nb_56, color = I("darkblue"), name = "56") %>% 
  add_bars(x = ~nb_44, color = I("pink"), name = "44") %>% 
  add_bars(x = ~nb_49, color = I("violet"), name = "49") %>% 
  add_bars(x = ~nb_53, color = I("orange"), name = "53") %>% 
  add_bars(x = ~nb_72, color = I("red"), name = "72") %>% 
  add_bars(x = ~nb_85, color = I("darkred"), name = "85") %>% 
  layout(yaxis = list(title = "Usage de l'ouvrage"),barmode = 'stack')  %>%
  layout(title = "Répartition des ouvrages selon leur 'Usage'",
         xaxis = list(title = "Nombre d'ouvrages"))

histo_roe_usage_bzh <-
  plot_ly(roe_usage_dprt, 
          type = 'bar', 
          y = ~fct_rev(usage_nom1), 
          x = ~nb_22, color = I("lightblue"), name = "22") %>%
  add_bars(x = ~nb_29, color = I("#18d0f0"), name = "29") %>% 
  add_bars(x = ~nb_35, color = I("blue"), name = "35") %>% 
  add_bars(x = ~nb_56, color = I("darkblue"), name = "56") %>%
  layout(yaxis = list(title = "Usage de l'ouvrage"),barmode = 'stack')  %>%
  layout(title = "Répartition des ouvrages selon leur 'Usage'",
         xaxis = list(title = "Nombre d'ouvrages"))

histo_roe_usage_pdl <-
  plot_ly(roe_usage_dprt, 
          type = 'bar', 
          y = ~fct_rev(usage_nom1), 
          x = ~nb_44, color = I("pink"), name = "44") %>% 
  add_bars(x = ~nb_49, color = I("violet"), name = "49") %>% 
  add_bars(x = ~nb_53, color = I("orange"), name = "53") %>% 
  add_bars(x = ~nb_72, color = I("red"), name = "72") %>% 
  add_bars(x = ~nb_85, color = I("darkred"), name = "85") %>% 
  layout(yaxis = list(title = "Usage de l'ouvrage"),barmode = 'stack')  %>%
  layout(title = "Répartition des ouvrages selon leur 'Usage'",
         xaxis = list(title = "Nombre d'ouvrages"))

#diag_usage <-
  ggplot(data = bdroe_dr2_valid, 
       aes(x = ifelse(usage_nom1 == '', "Non-renseigné", usage_nom1))) +
  geom_bar(fill = "lightblue") +
  coord_flip() +
  labs(x = "Type d'usage",
       y = "Nombre d'ouvrages",
       title = "Type d'usage des ouvrages connus en Bretagne et Pays-de-la-Loire")

## Dynamique de renseignement 

brdoe2 <- bdroe %>%
  mutate(date = substr(date_modification, 1,10),
         date2 = substr(date_validation, 1,10)) %>%
  mutate(date = ifelse(!is.na(date), date, date2))

histo_roe_date <-
  ggplot(data = brdoe2 , 
         aes(x = lubridate::ymd(date), fill = dept_code)) +
  geom_histogram(position = "dodge", bins = 20) +
  labs(x = "'Date de modification' de l'ouvrage",
       y = "Nombre d'observations",
       title = "Dynamique de renseignement des ouvrages dans le ROE", 
       subtitle = "2009 - 2024", 
       fill = "Département") + 
  scale_x_date(
    date_labels = "%b\n%Y",
    date_breaks = "year")+
  theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1))

histo_roe_date_bzh <-
  ggplot(data = brdoe2 %>%
           filter(dept_code %in% c('22', '29', '35', '56')), 
         aes(x = lubridate::ymd(date), fill = dept_code )) +
  geom_histogram(position = "dodge", bins = 20) +
  labs(x = "'Date de modification' de l'ouvrage",
       y = "Nombre d'observations",
       title = "Dynamique de renseignement des ouvrages dans le ROE", 
       subtitle = "2009 - 2024", 
       fill = "Département") + 
  scale_x_date(
    date_labels = "%b\n%Y",
    date_breaks = "year")+
  theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1))

histo_roe_date_pdl <-
  ggplot(data = brdoe2 %>%
           filter(dept_code %in% c('44','49','53','72','85')), 
         aes(x = lubridate::ymd(date), fill = dept_code)) +
  geom_histogram(position = "dodge", bins = 20) +
  labs(x = "'Date de modification' de l'ouvrage",
       y = "Nombre d'observations",
       title = "Dynamique de renseignement des ouvrages dans le ROE", 
       subtitle = "2009 - 2024", 
       fill = "Département") + 
  scale_x_date(
    date_labels = "%b\n%Y",
    date_breaks = "year")+
  theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1))

ggplotly(histo_roe_date)

diag_dynamique <-
  ggplot(data = bdroe_dr2_valid, 
       aes(x = mutate(date_modification = as.Date(date_modification)))) +
  geom_histogram(fill = "blue") +
  labs(x = "Date de l'observation",
       y = "Nombre d'ouvrages",
       title = "Dynamique de renseignement : date de modification")   

ggplot(data = bdroe_dr2_valid, 
       aes(x = lubridate::ymd(mutate(date_modification = as.Date(date_modification))))) +
  geom_histogram(bins = 100) +
  labs(x = "Date de l'observation",
       y = "Nombre d'observations",
       title = "Dynamique de renseignement des observations dans OISON",
       subtitle = "Juin 1978 - Septembre 2024")     +
  scale_x_date(date_breaks = 'year')+
  theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1)) 

histo_obs_bocage_date_2024 <-
  ggplot(data = oison_bzh_bocage %>%
           filter(substr(date, 1,4) == 2024), 
         aes(x = lubridate::ymd(date), fill = INSEE_DEP)) +
  geom_histogram(position = "dodge", bins = 50) +
  labs(x = "Date de l'observation",
       y = "Nombre d'observations",
       title = "Dynamique de renseignement des observations 'Bocage' dans OISON", 
       subtitle = "Janvier - Septembre 2024", 
       fill = "Département") + 
  scale_x_date(
    date_labels = "%b\n%Y",
    date_breaks = "month")+
  theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1))

save(bdroe_dr2_valid,
     histo_roe_etat,
     histo_roe_type,
     histo_roe_fpi,
     histo_roe_hc,
     histo_roe_atg,
     histo_roe_usage,
     histo_roe_date,
     file = "data/outputs/bdroe_valid.RData")

save(bdroe_dr2_valid,
     histo_roe_etat_bzh,
     histo_roe_type_bzh,
     histo_roe_fpi_bzh,
     histo_roe_hc_bzh,
     histo_roe_atg_bzh,
     histo_roe_usage_bzh,
     histo_roe_date_bzh,
     file = "data/outputs/bdroe_valid_bzh.RData")

save(bdroe_dr2_valid,
     histo_roe_etat_pdl,
     histo_roe_type_pdl,
     histo_roe_fpi_pdl,
     histo_roe_hc_pdl,
     histo_roe_atg_pdl,
     histo_roe_usage_pdl,
     histo_roe_date_pdl,
     file = "data/outputs/bdroe_valid_pdl.RData")
